name: Weekly Summary

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger for testing

jobs:
  summary:
    runs-on: [gyrinx-ubuntu-2]
    timeout-minutes: 15
    permissions:
      contents: read
      discussions: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get date range
        id: dates
        run: |
          python3 << 'PY'
          import datetime
          import os

          def ordinal(n):
              return str(n) + ("th" if 11 <= n % 100 <= 13 else {1: "st", 2: "nd", 3: "rd"}.get(n % 10, "th"))

          today = datetime.date.today()
          start = today - datetime.timedelta(days=7)

          # Format: "Jan 4th"
          week_of = f"{start.strftime('%b')} {ordinal(start.day)}"

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"end_date={today.strftime('%Y-%m-%d')}\n")
              f.write(f"start_date={start.strftime('%Y-%m-%d')}\n")
              f.write(f"week_of={week_of}\n")
          PY

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Write prompt
        env:
          START_DATE: ${{ steps.dates.outputs.start_date }}
          END_DATE: ${{ steps.dates.outputs.end_date }}
        run: |
          python3 << 'PY'
          import os
          import textwrap

          start_date = os.environ["START_DATE"]
          end_date = os.environ["END_DATE"]

          prompt = textwrap.dedent(f"""\
              Create a summary of what landed in Gyrinx over the last 7 days.

              The date range is {start_date} to {end_date}.

              ## Step 1: Get the merged PRs

              Run this command to get the PRs merged in the last 7 days:
              ```bash
              gh pr list --state merged --search "merged:>={start_date}" --json number,title,body --limit 50
              ```

              ## Step 2: Write the summary

              Start with a short intro like "Changes from January 4th to 11th:" followed by a one-sentence overall summary of the week.

              Then write bullet points that:
              - Use British English spellings (e.g., "organised" not "organized", "colour" not "color")
              - Are casual but slightly technical (aimed at users who understand the app)
              - For bug fixes, explain what was broken in plain terms (e.g., "Dead fighters were showing up in gang counts" not "Fixed query filter")
              - For features, focus on what's now possible
              - Use impersonal language (not "your gang" but "gangs" or "the gang page")
              - Skip purely internal/code-cleanup stuff unless it's interesting
              - Keep each bullet to 1-2 sentences max
              - Use bold for the key thing in each bullet

              Don't include:
              - PR numbers
              - Dependency updates unless they're significant
              - CI/workflow changes
              - Admin interface changes (at most one bullet if significant)

              Format: Intro line, blank line, then bullet points starting with dashes.

              Example style:
              Changes from January 4th to 11th: A week of bug fixes and UI polish.

              - **Dead fighters no longer appear in gang counts** - they were sneaking into the summary even after dying
              - **Equipment filters persist** when adding items, instead of resetting each time

              If there were no meaningful user-facing changes, return: "Changes from [date range]: Quiet week! No major updates."

              Output ONLY the summary text, nothing else.
          """)

          with open("/tmp/claude-prompt.txt", "w") as f:
              f.write(prompt)
          PY

      - name: Generate weekly summary
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          claude -p \
            --model claude-sonnet-4-20250514 \
            --allowedTools "Bash(git:*),Bash(gh:*)" \
            < /tmp/claude-prompt.txt \
            > /tmp/weekly-summary.txt

          echo "Generated summary:"
          cat /tmp/weekly-summary.txt

      - name: Create discussion
        env:
          GH_TOKEN: ${{ github.token }}
          WEEK_OF: ${{ steps.dates.outputs.week_of }}
        run: |
          set -e

          BODY=$(cat /tmp/weekly-summary.txt)

          if [ -z "$BODY" ]; then
            echo "::error::No summary generated"
            exit 1
          fi

          # Validate summary contains expected format (intro line or bullet points)
          if ! echo "$BODY" | grep -qE '(^- |^Changes from)'; then
            echo "::error::Summary doesn't contain expected format"
            echo "$BODY"
            exit 1
          fi

          echo "Summary:"
          echo "$BODY"

          # Get repo node ID
          REPO_ID=$(gh api repos/${{ github.repository }} --jq .node_id)
          if [ -z "$REPO_ID" ]; then
            echo "::error::Failed to get repository node ID"
            exit 1
          fi

          # Create the discussion
          # Category ID is for "Announcements" - found via:
          # gh api graphql -f query='{ repository(owner:"gyrinx-app",name:"gyrinx") { discussionCategories(first:10) { nodes { id name } } } }'
          gh api graphql -f query='
            mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {
                repositoryId: $repoId,
                categoryId: $categoryId,
                title: $title,
                body: $body
              }) {
                discussion {
                  url
                }
              }
            }
          ' \
            -f repoId="$REPO_ID" \
            -f categoryId="DIC_kwDOM_QUS84C0zc-" \
            -f title="What's new? Week of $WEEK_OF" \
            -f body="$BODY"
