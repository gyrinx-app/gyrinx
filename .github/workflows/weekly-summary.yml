name: Weekly Summary

on:
  schedule:
    # Run every Monday at 9am UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:
    inputs:
      start_date:
        description: "Override start date (YYYY-MM-DD). Defaults to last successful run date."
        required: false
        type: string

jobs:
  summary:
    runs-on: [gyrinx-ubuntu-2]
    permissions:
      actions: read
      contents: read
      discussions: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Need full history for git log

      # Workaround for anthropics/claude-code-action#900: the action's
      # checkHumanActor calls the GitHub API before checking allowed_bots,
      # which 404s for bot actors like github-merge-queue[bot]. Override
      # GITHUB_ACTOR so the action sees a real user. Run unconditionally
      # for scheduled events because github.actor may be a bot name with
      # or without the [bot] suffix.
      - name: Fix actor for scheduled runs
        if: github.event_name == 'schedule'
        run: echo "GITHUB_ACTOR=${{ github.repository_owner }}" >> "$GITHUB_ENV"

      - name: Get date range
        id: dates
        env:
          GH_TOKEN: ${{ github.token }}
          INPUT_START_DATE: ${{ inputs.start_date }}
          CURRENT_RUN_NUMBER: ${{ github.run_number }}
        run: |
          python3 << 'PY'
          import datetime
          import json
          import os
          import subprocess

          def ordinal(n):
              return str(n) + ("th" if 11 <= n % 100 <= 13 else {1: "st", 2: "nd", 3: "rd"}.get(n % 10, "th"))

          today = datetime.date.today()

          # Determine start date
          manual_start = os.environ.get("INPUT_START_DATE", "").strip()
          if manual_start:
              try:
                  start = datetime.date.fromisoformat(manual_start)
              except ValueError:
                  print(f"::error::Invalid start_date '{manual_start}'. Expected format: YYYY-MM-DD")
                  raise
              print(f"Using manual start date: {start.isoformat()}")
          else:
              # Find the last successful run of this workflow, excluding the current run
              result = subprocess.run(
                  ["gh", "run", "list", "--workflow", "weekly-summary.yml",
                   "--status", "success", "--limit", "2",
                   "--json", "createdAt,number"],
                  capture_output=True, text=True
              )
              if result.returncode != 0:
                  print(f"Warning: gh run list failed (code {result.returncode}): {result.stderr.strip()}")
                  runs = []
              else:
                  try:
                      runs = json.loads(result.stdout)
                  except json.JSONDecodeError as e:
                      print(f"Warning: failed to parse gh output: {e}")
                      runs = []
              current_run = int(os.environ.get("CURRENT_RUN_NUMBER", "0"))
              runs = [r for r in runs if r["number"] != current_run]

              if runs:
                  start = datetime.date.fromisoformat(runs[0]["createdAt"][:10])
                  print(f"Using last successful run date: {start.isoformat()}")
              else:
                  start = today - datetime.timedelta(days=7)
                  print(f"No prior successful run found, falling back to 7 days: {start.isoformat()}")

          # Format: "Jan 4th"
          week_of = f"{start.strftime('%b')} {ordinal(start.day)}"

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"end_date={today.strftime('%Y-%m-%d')}\n")
              f.write(f"start_date={start.strftime('%Y-%m-%d')}\n")
              f.write(f"week_of={week_of}\n")
          PY

      - name: Run Claude Weekly Summary
        id: claude
        uses: anthropics/claude-code-action@v1
        env:
          START_DATE: ${{ steps.dates.outputs.start_date }}
          END_DATE: ${{ steps.dates.outputs.end_date }}
          GH_TOKEN: ${{ github.token }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # Belt-and-suspenders: also declare the bot as allowed in case the
          # GITHUB_ACTOR override above is removed once the upstream bug is fixed.
          allowed_bots: "github-merge-queue[bot]"

          claude_args: |
            --model claude-sonnet-4-20250514
            --allowedTools "Bash(git:*),Bash(gh:*)"
            --json-schema '{"type":"object","properties":{"summary":{"type":"string","description":"The bullet-point summary in markdown format"}},"required":["summary"]}'

          prompt: |
            Create a summary of what landed in Gyrinx since the last weekly summary.

            The date range is $START_DATE to $END_DATE.

            ## Step 1: Get the merged PRs

            Run this command to get the PRs merged in this period:
            ```bash
            gh pr list --state merged --search "merged:>=$START_DATE" --json number,title,body --limit 50
            ```

            ## Step 2: Write the summary

            Start with a short intro like "Changes from January 4th to 11th:" followed by a one-sentence overall summary of the week.

            Then write bullet points that:
            - Use British English spellings (e.g., "organised" not "organized", "colour" not "color")
            - Are casual but slightly technical (aimed at users who understand the app)
            - For bug fixes, explain what was broken in plain terms (e.g., "Dead fighters were showing up in gang counts" not "Fixed query filter")
            - For features, focus on what's now possible
            - Use impersonal language (not "your gang" but "gangs" or "the gang page")
            - Skip purely internal/code-cleanup stuff unless it's interesting
            - Keep each bullet to 1-2 sentences max
            - Use bold for the key thing in each bullet

            Don't include:
            - PR numbers
            - Dependency updates unless they're significant
            - CI/workflow changes
            - Admin interface changes (at most one bullet if significant)

            Format: Intro line, blank line, then bullet points starting with dashes.

            Example style:
            Changes from January 4th to 11th: A week of bug fixes and UI polish.

            - **Dead fighters no longer appear in gang counts** - they were sneaking into the summary even after dying
            - **Equipment filters persist** when adding items, instead of resetting each time

            If there were no meaningful user-facing changes, return: "Changes from [date range]: Quiet week! No major updates."

            Return the full summary in the structured output.

      - name: Create discussion
        env:
          GH_TOKEN: ${{ github.token }}
          WEEK_OF: ${{ steps.dates.outputs.week_of }}
          SUMMARY_JSON: ${{ steps.claude.outputs.structured_output }}
        run: |
          set -e

          # Extract summary from structured output
          BODY=$(echo "$SUMMARY_JSON" | jq -r '.summary')

          if [ -z "$BODY" ] || [ "$BODY" = "null" ]; then
            echo "::error::No summary in structured output"
            echo "Raw output: $SUMMARY_JSON"
            exit 1
          fi

          # Validate summary contains expected format (intro line or bullet points)
          if ! echo "$BODY" | grep -qE '(^- |^Changes from)'; then
            echo "::error::Summary doesn't contain expected format"
            echo "$BODY"
            exit 1
          fi

          echo "Summary:"
          echo "$BODY"

          # Get repo node ID
          REPO_ID=$(gh api repos/${{ github.repository }} --jq .node_id)
          if [ -z "$REPO_ID" ]; then
            echo "::error::Failed to get repository node ID"
            exit 1
          fi

          # Create the discussion
          # Category ID is for "Announcements" - found via:
          # gh api graphql -f query='{ repository(owner:"gyrinx-app",name:"gyrinx") { discussionCategories(first:10) { nodes { id name } } } }'
          gh api graphql -f query='
            mutation($repoId: ID!, $categoryId: ID!, $title: String!, $body: String!) {
              createDiscussion(input: {
                repositoryId: $repoId,
                categoryId: $categoryId,
                title: $title,
                body: $body
              }) {
                discussion {
                  url
                }
              }
            }
          ' \
            -f repoId="$REPO_ID" \
            -f categoryId="DIC_kwDOM_QUS84C0zc-" \
            -f title="What's new? Week of $WEEK_OF" \
            -f body="$BODY"
