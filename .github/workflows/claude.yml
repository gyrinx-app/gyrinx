name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude-bot') && github.event.comment.user.login == 'tgvashworth') ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude-bot') && github.event.comment.user.login == 'tgvashworth') ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude-bot') && github.event.review.user.login == 'tgvashworth') ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude-bot') || contains(github.event.issue.title, '@claude-bot')) && github.event.issue.user.login == 'tgvashworth')
    runs-on: [gyrinx-ubuntu-2]
    timeout-minutes: 60
    permissions:
      contents: write
      pull-requests: write
      issues: read
      id-token: write
      actions: read
    steps:
      # - name: Prevent direct pushes to main
      #   env:
      #     REF: ${{ github.ref }}
      #     BASE_REF: ${{ github.base_ref }}
      #     PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
      #   run: |
      #     if [ "$REF" = "refs/heads/main" ] || [ "$BASE_REF" = "main" ] || [ "$PR_BASE_REF" = "main" ]; then
      #       echo "::error::This workflow cannot run on or target the main branch directly"
      #       exit 1
      #     fi
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Cache pip
        id: cache-pip
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Cache npm dependencies
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install dependencies
        run: |
          python -m venv .venv && \
          . .venv/bin/activate && \
          pip install --editable .
      - name: Write to .env file
        run: |
          echo "SECRET_KEY=test-secret" >> .env
          echo "DJANGO_SUPERUSER_PASSWORD=password" >> .env
      - name: Install Node dependencies
        run: npm ci

      - name: Install pre-commit
        run: |
          . .venv/bin/activate && \
          pip install pre-commit
      - name: Install pre-commit hooks
        run: |
          . .venv/bin/activate && \
          pre-commit install --install-hooks

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # This is an optional setting that allows Claude to read CI results on PRs
          additional_permissions: |
            actions: read

          # Customize the trigger phrase to match job condition
          trigger_phrase: "@claude-bot"

          # Trigger when specific user is assigned to an issue
          assignee_trigger: "claude-bot"

          # Claude configuration via CLI arguments
          claude_args: |
            --model claude-opus-4-5-20251101
            --allowedTools Bash
            --system-prompt "IMPORTANT: Before running any Python code, tests, or linting tools, you MUST first run:
            pip install --editable .

            This installs all project dependencies defined in pyproject.toml, including:
            - pytest for testing
            - ruff for linting and formatting
            - All other development dependencies

            Then you MUST activate the virtual environment with:
            source .venv/bin/activate

            CRITICAL TEST REQUIREMENTS:
            1. BEFORE committing any changes, you MUST run the tests using: pytest
            2. Check the test output - ALL tests must pass (no failures, no errors)
            3. If ANY tests fail, you MUST fix them before proceeding
            4. Only commit and push after ALL tests pass successfully

            For formatting:
            - Run ./scripts/fmt.sh to format all code
            - Or use: ruff format . && ruff check --fix --unsafe-fixes

            WORKFLOW FOR COMPLETING TASKS:
            1. Make the requested changes
            2. Run formatting: ./scripts/fmt.sh
            3. Run tests: ./scripts/test.sh (in docker to ensure posgres is available)
            4. Verify ALL tests pass
            5. If tests fail, fix the issues and repeat steps 2-4
            6. Only after all tests pass, commit and push your changes

            When completing a task, you MUST commit any changes you make before you can report success and stop."

          # Optional: Custom environment variables for Claude
          # claude_env: |
          #   NODE_ENV: test
