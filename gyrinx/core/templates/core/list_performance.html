{% extends "core/layouts/foundation.html" %}
{% load allauth custom_tags %}
{% block head_title %}
    {{ list.name }} | {{ list.owner_cached }}
{% endblock head_title %}
{% block base %}
    <div class="border rounded m-2 mb-3 p-2 mb-last-0 text-muted">
        Stuff that is not here yet, but could later be optimised:
        <ul>
            <li>
                <em>Cost</em> — this is the big one. Currently around 14 queries per fighter, which is a lot.
            </li>
            <li>
                <em>Refs</em> — using the ref tag. These are already fairly optimised and cached.
            </li>
        </ul>
    </div>
    <h2>List Details</h2>
    <ul>
        <li>{{ list.name }}</li>
        <li>Archived? {{ list.archived|yesno:"Yes,No" }}</li>
        <li>{{ list.owner_cached }}</li>
        <li>{{ list.owner_cached.username }}</li>
        <li>{{ list.content_house_name }}</li>
        <li>{{ list.is_campaign_mode }}</li>
        <li>
            {% if list.public %}
                Public
            {% else %}
                Unlisted
            {% endif %}
        </li>
        <li>
            {% if list.owner_cached == user %}Owner{% endif %}
        </li>
        <li>{{ list.original_list }}</li>
        <li>{{ list.campaign }}</li>
        <li>Clones? {{ list.active_campaign_clones|length|yesno:"Yes,No" }}</li>
    </ul>
    <h2>List Attributes</h2>
    <ul>
        {% for attribute_assign in list.active_attributes_cached %}
            <li>{{ attribute_assign.attribute_value.name }}: {{ attribute_assign.attribute_value.attribute }}</li>
        {% empty %}
            <li>No attributes assigned.</li>
        {% endfor %}
    </ul>
    <h2>Available Attributes</h2>
    {% if list.all_attributes %}
        <table class="table table-sm mb-0 fs-7">
            <tbody>
                {% for attribute in list.all_attributes %}
                    <tr>
                        <td>{{ attribute.name }}</td>
                        <td>
                            {% if attribute.assignments %}
                                {{ attribute.assignments|join:", " }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p class="text-muted fs-7 mb-0">No attributes available.</p>
    {% endif %}
    <h2>List Fighters</h2>
    <table class="table table-sm mb-0 fs-7">
        <tbody>
            <tr>
                <th rowspan="2">Name</th>
                <th>Category Label / CF Cat / Override</th>
                <th>Base Cost</th>
                <th>Advancement Cost</th>
                <th>Injury State</th>
                <th>Captured / Sold to Guilders</th>
                <th>Linked Fighter</th>
                <th>Cost Override</th>
            </tr>
            <tr>
                <th>Legacy House / Takes Legacy</th>
                <th colspan="2">Statline</th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
            {% for fighter in list.active_fighters %}
                <tr>
                    <td rowspan="2">{{ fighter.name }}</td>
                    <td>{{ fighter.get_category_label }} / {{ fighter.content_fighter_cached.cat }} / {{ fighter.category_override }}</td>
                    <td>{{ fighter.base_cost_display }}</td>
                    <td>{{ fighter.advancement_cost_display }}</td>
                    <td>{{ fighter.get_injury_state_display }}</td>
                    <td>
                        {{ fighter.is_captured |yesno:"Captured,Not Captured" }} / {{ fighter.is_sold_to_guilders |yesno:"Sold to Guilders,Not Sold" }}
                    </td>
                    <td>
                        {% if fighter.has_linked_fighter %}
                            {{ fighter.term_proximal_demonstrative }} is linked
                            to {{ fighter.linked_list_fighter.name }}
                        {% else %}
                            <span class="text-muted fst-italic">No linked fighter</span>
                        {% endif %}
                    </td>
                    <td>{{ fighter.has_overridden_cost |yesno:"Cost overridden,No override" }}</td>
                </tr>
                <tr>
                    <td>
                        {% if fighter.legacy_content_fighter_cached %}
                            {{ fighter.legacy_content_fighter_cached.house.name }}
                        {% else %}
                            <span class="text-muted fst-italic">No legacy</span>
                        {% endif %}
                        / {{ fighter.can_take_legacy |yesno:"Yes,No" }}
                    </td>
                    <td colspan="2">
                        <small>
                            {% for stat in fighter.statline %}
                                {{ stat.name }}: {{ stat.value }}
                                {% if not forloop.last %}|{% endif %}
                            {% endfor %}
                        </small>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td>No fighters in this list.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endblock base %}
