{% extends "core/layouts/base.html" %}
{% load allauth custom_tags %}
{% block head_title %}
    {{ title }} - {{ list.name }}
{% endblock head_title %}
{% block content %}
    {% include "core/includes/list_common_header.html" with list=list link_list="true" %}
    <div class="col-12 col-md-8 col-lg-6 px-0 vstack gap-3">
        <h1 class="h3">{{ title }}</h1>
        <form method="post" class="vstack gap-4">
            {% csrf_token %}
            <!-- Configuration Name -->
            <div>
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name.errors }}
                {{ form.name }}
                <small class="form-text text-muted">{{ form.name.help_text }}</small>
            </div>
            <!-- Card Types Section -->
            <div>
                <h2 class="h5 mb-3">Card Types</h2>
                <p class="text-muted small mb-3">Select which types of cards to include in the print output.</p>
                <div class="vstack gap-2">
                    <div class="form-check">
                        {{ form.include_assets }}
                        <label class="form-check-label" for="{{ form.include_assets.id_for_label }}">Include Asset Card</label>
                    </div>
                    <div class="form-check">
                        {{ form.include_attributes }}
                        <label class="form-check-label"
                               for="{{ form.include_attributes.id_for_label }}">Include Attribute Card</label>
                    </div>
                    <div class="form-check">
                        {{ form.include_stash }}
                        <label class="form-check-label" for="{{ form.include_stash.id_for_label }}">Include Stash Card</label>
                    </div>
                    <div class="form-check">
                        {{ form.include_actions }}
                        <label class="form-check-label"
                               for="{{ form.include_actions.id_for_label }}">Include Action Card</label>
                    </div>
                    <div class="form-check">
                        {{ form.include_dead_fighters }}
                        <label class="form-check-label"
                               for="{{ form.include_dead_fighters.id_for_label }}">Include Dead Fighters</label>
                    </div>
                </div>
            </div>
            <!-- Fighter Selection Section -->
            <div>
                <h2 class="h5 mb-3">Fighter Selection</h2>
                <p class="text-muted small mb-3">{{ form.included_fighters.help_text }}</p>
                <div class="border rounded p-3 overflow-auto">
                    <div class="vstack gap-2 mb-3 border-bottom pb-3">
                        {% for choice in form.fighter_selection_mode %}
                            <div class="form-check">
                                {{ choice.tag }}
                                <label class="form-check-label" for="{{ choice.id_for_label }}">{{ choice.choice_label }}</label>
                            </div>
                        {% endfor %}
                    </div>
                    {% if form.included_fighters.field.queryset %}
                        <div class="vstack gap-2" id="fighter-checkboxes">
                            {% for choice in form.included_fighters %}{{ choice }}{% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0" id="no-fighters-message">No fighters available.</p>
                    {% endif %}
                </div>
            </div>
            <!-- Blank Cards Section -->
            <div class="border rounded p-3">
                <h2 class="h5 mb-0">
                    <button class="btn btn-link text-decoration-none p-0 text-start w-100 d-flex align-items-center"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#blankCardsCollapse"
                            aria-expanded="false"
                            aria-controls="blankCardsCollapse">
                        <span class="me-2">Blank Cards</span>
                        <i class="bi bi-chevron-down ms-auto"
                           data-gy-collapse-icon="blankCardsCollapse"></i>
                    </button>
                </h2>
                <p class="text-muted small mb-0">Add blank cards to fill in at the table (e.g., when gaining new fighters).</p>
                <div class="collapse" id="blankCardsCollapse">
                    <div class="vstack gap-3 mt-3">
                        <div>
                            <label for="{{ form.blank_fighter_cards.id_for_label }}" class="form-label">
                                {{ form.blank_fighter_cards.label }}
                            </label>
                            {{ form.blank_fighter_cards.errors }}
                            {{ form.blank_fighter_cards }}
                            <small class="form-text text-muted">{{ form.blank_fighter_cards.help_text }}</small>
                        </div>
                        <div>
                            <label for="{{ form.blank_vehicle_cards.id_for_label }}" class="form-label">
                                {{ form.blank_vehicle_cards.label }}
                            </label>
                            {{ form.blank_vehicle_cards.errors }}
                            {{ form.blank_vehicle_cards }}
                            <small class="form-text text-muted">{{ form.blank_vehicle_cards.help_text }}</small>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Form Actions -->
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    {% if print_config %}
                        Update
                    {% else %}
                        Create
                    {% endif %}
                    Configuration
                </button>
                {% url 'core:print-config-index' list.id as cancel_url %}
                {% include "core/includes/cancel.html" with url=cancel_url %}
            </div>
        </form>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const modeRadios = document.querySelectorAll('input[name="fighter_selection_mode"]');
            const fighterCheckboxes = document.querySelectorAll('#fighter-checkboxes input[type="checkbox"]');
            const fighterCheckboxesContainer = document.getElementById('fighter-checkboxes');

            function updateFighterCheckboxesState() {
                const selectedMode = document.querySelector('input[name="fighter_selection_mode"]:checked')?.value;

                if (selectedMode === 'specific') {
                    // Enable fighter checkboxes
                    fighterCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                    });
                    if (fighterCheckboxesContainer) {
                        fighterCheckboxesContainer.style.opacity = '1';
                    }
                } else {
                    // Disable and uncheck fighter checkboxes
                    fighterCheckboxes.forEach(checkbox => {
                        checkbox.disabled = true;
                        checkbox.checked = false;
                    });
                    if (fighterCheckboxesContainer) {
                        fighterCheckboxesContainer.style.opacity = '0.5';
                    }
                }
            }

            // Update state when mode changes
            modeRadios.forEach(radio => {
                radio.addEventListener('change', updateFighterCheckboxesState);
            });

            // Set initial state
            updateFighterCheckboxesState();
        });
    </script>
{% endblock content %}
