{% extends "core/layouts/base.html" %}
{% load allauth custom_tags %}
{% block head_title %}
    {{ pack.name }}
{% endblock head_title %}
{% block content %}
    {% include "core/includes/back.html" with url="/packs/" text="Customisation" %}
    <div class="col-12 col-xl-8 px-0 vstack gap-5">
        <!-- Header -->
        <div class="vstack gap-0">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 mb-2">
                <h1 class="mb-0">{{ pack.name }}</h1>
                {% if is_owner %}
                    <nav class="nav btn-group flex-nowrap ms-md-auto">
                        <a href="{% url 'core:pack-edit' pack.id %}"
                           class="btn btn-primary btn-sm">
                            <i class="bi-pencil"></i> Edit
                        </a>
                    </nav>
                {% endif %}
            </div>
            <div class="d-flex flex-wrap gap-2 text-muted small">
                <span><i class="bi-person"></i> <a class="linked" href="{% url 'core:user' pack.owner.username %}">{{ pack.owner }}</a></span>
                {% if pack.listed %}
                    <span data-bs-toggle="tooltip"
                          data-bs-title="This Content Pack is visible to all users"><i class="bi-eye"></i> Public</span>
                {% else %}
                    <span data-bs-toggle="tooltip"
                          data-bs-title="This Content Pack can only be accessed by users with the direct link"><i class="bi-eye-slash"></i> Unlisted</span>
                {% endif %}
            </div>
        </div>
        <!-- Pack info -->
        {% if pack.summary or pack.description %}
            <div class="vstack gap-1 col-md-9">
                {% if pack.summary %}<div class="mb-last-0">{{ pack.summary|safe_rich_text|safe }}</div>{% endif %}
                {% if pack.description %}
                    <div class="text-muted fs-7 mb-last-0">{{ pack.description|safe_rich_text|safe }}</div>
                {% endif %}
            </div>
        {% endif %}
        <!-- Content -->
        {% for section in content_sections %}
            <section>
                <div class="d-flex justify-content-between align-items-center mb-3 bg-body-secondary rounded px-2 py-1">
                    <h2 class="h5 mb-0">
                        {{ section.label }}
                        {% if section.count > 0 %}<span class="badge bg-primary">{{ section.count }}</span>{% endif %}
                    </h2>
                    {% if is_owner %}
                        <span class="d-flex gap-2 align-items-center">
                            {% if section.archived_count > 0 %}
                                <a href="{% url 'core:pack-archived-items' pack.id section.slug %}"
                                   class="link-secondary link-underline-opacity-25 link-underline-opacity-100-hover small">Archived ({{ section.archived_count }})</a>
                            {% endif %}
                            {% if section.can_add %}
                                <a href="{% url 'core:pack-add-item' pack.id section.slug %}"
                                   class="btn btn-primary btn-sm">
                                    <i class="bi-plus-lg"></i> Add
                                </a>
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                {% if section.items %}
                    <ul class="list-unstyled mb-0">
                        {% for entry in section.items %}
                            <li class="py-1 d-flex justify-content-between align-items-center">
                                <span>{{ entry.content_object }}</span>
                                {% if is_owner %}
                                    <span class="d-flex gap-2">
                                        {% if section.can_add %}
                                            <a href="{% url 'core:pack-edit-item' pack.id entry.pack_item.id %}"
                                               class="link-secondary link-underline-opacity-25 link-underline-opacity-100-hover small">Edit</a>
                                        {% endif %}
                                        <a href="{% url 'core:pack-delete-item' pack.id entry.pack_item.id %}"
                                           class="link-danger link-underline-opacity-25 link-underline-opacity-100-hover small">Archive</a>
                                    </span>
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-secondary mb-0">No {{ section.label|lower }} in this Content Pack yet.</p>
                {% endif %}
            </section>
        {% endfor %}
        <!-- Subscribe to this pack -->
        {% if user_lists %}
            <section>
                <div class="d-flex justify-content-between align-items-center mb-3 bg-body-secondary rounded px-2 py-1">
                    <h2 class="h5 mb-0">Your Lists</h2>
                </div>
                {% if unsubscribed_lists %}
                    <form method="post" action="{% url 'core:pack-subscribe' pack.id %}" class="mb-3">
                        {% csrf_token %}
                        <div class="d-flex gap-2 align-items-end">
                            <div class="flex-grow-1">
                                <label for="list_id" class="form-label small text-muted">Add this pack to a list</label>
                                <select name="list_id" id="list_id" class="form-select form-select-sm">
                                    {% for lst in unsubscribed_lists %}
                                        <option value="{{ lst.id }}">{{ lst.name }} ({{ lst.content_house }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm">Add to List</button>
                        </div>
                    </form>
                {% endif %}
                {% if subscribed_list_ids %}
                    <div class="small text-muted mb-2">Subscribed lists:</div>
                    <ul class="list-unstyled mb-0">
                        {% for lst in user_lists %}
                            {% if lst.id in subscribed_list_ids %}
                                <li class="py-1 d-flex justify-content-between align-items-center">
                                    <span>
                                        <a href="{% url 'core:list' lst.id %}" class="linked">{{ lst.name }}</a>
                                        <span class="text-muted small">({{ lst.content_house }})</span>
                                    </span>
                                    <form method="post" action="{% url 'core:pack-unsubscribe' pack.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="list_id" value="{{ lst.id }}">
                                        <button type="submit" class="btn btn-link btn-sm link-danger link-underline-opacity-25 link-underline-opacity-100-hover p-0">Remove</button>
                                    </form>
                                </li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                {% endif %}
                {% if not unsubscribed_lists and not subscribed_list_ids %}
                    <p class="text-muted small mb-0">You have no lists to subscribe to this pack.</p>
                {% endif %}
            </section>
        {% endif %}
        <!-- Activity -->
        <section>
            <div class="d-flex justify-content-between align-items-center mb-3 bg-body-secondary rounded px-2 py-1">
                <h2 class="h5 mb-0">Activity</h2>
                {% if total_activity_count > 0 %}
                    <a href="{% url 'core:pack-activity' pack.id %}"
                       class="link-primary link-underline-opacity-25 link-underline-opacity-100-hover small">View all →</a>
                {% endif %}
            </div>
            {% if recent_activities %}
                <div class="list-group list-group-flush">
                    {% for activity in recent_activities %}
                        {% include "core/includes/pack_activity_item.html" with activity=activity %}
                    {% endfor %}
                </div>
                {% if total_activity_count > 5 %}
                    <a href="{% url 'core:pack-activity' pack.id %}"
                       class="small mt-2 d-inline-block">View all {{ total_activity_count }} activities →</a>
                {% endif %}
            {% else %}
                <p class="text-muted small mb-0">No activity yet.</p>
            {% endif %}
        </section>
    </div>
{% endblock content %}
