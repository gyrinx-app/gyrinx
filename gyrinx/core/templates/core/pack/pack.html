{% extends "core/layouts/base.html" %}
{% load allauth custom_tags %}
{% block head_title %}
    {{ pack.name }}
{% endblock head_title %}
{% block content %}
    {% include "core/includes/back.html" with url="/packs/" text="Customisation" %}
    <div class="col-12 col-xl-8 px-0 vstack gap-5">
        <!-- Header -->
        <div class="vstack gap-0">
            <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2 mb-2">
                <h1 class="mb-0">{{ pack.name }}</h1>
                {% if can_edit or user_lists or user_campaigns %}
                    <nav class="btn-group flex-nowrap ms-md-auto">
                        {% if can_edit %}
                            <a href="{% url 'core:pack-edit' pack.id %}"
                               class="btn btn-primary btn-sm">
                                <i class="bi-pencil"></i> Edit
                            </a>
                        {% endif %}
                        <div class="btn-group" role="group">
                            <button type="button"
                                    class="btn btn-primary btn-sm dropdown-toggle"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    aria-label="More options">
                                <i class="bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                {% if is_owner %}
                                    <li>
                                        <a href="{% url 'core:pack-permissions' pack.id %}"
                                           class="dropdown-item icon-link">
                                            <i class="bi-people"></i> Permissions
                                        </a>
                                    </li>
                                {% endif %}
                                {% if user_lists %}
                                    <li>
                                        <a href="{% url 'core:pack-lists' pack.id %}"
                                           class="dropdown-item icon-link">
                                            <i class="bi-list-ul"></i> Add to Lists
                                            {% if subscribed_list_ids %}<span class="badge bg-primary ms-1">{{ subscribed_list_ids|length }}</span>{% endif %}
                                        </a>
                                    </li>
                                {% endif %}
                                {% if user_campaigns %}
                                    <li>
                                        <a href="{% url 'core:pack-campaigns' pack.id %}"
                                           class="dropdown-item icon-link">
                                            <i class="bi-flag"></i> Add to Campaigns
                                            {% if subscribed_campaign_ids %}
                                                <span class="badge bg-primary ms-1">{{ subscribed_campaign_ids|length }}</span>
                                            {% endif %}
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </div>
                    </nav>
                {% endif %}
            </div>
            <div class="d-flex flex-wrap gap-2 text-muted small">
                <span><i class="bi-person"></i> <a class="linked" href="{% url 'core:user' pack.owner.username %}">{{ pack.owner }}</a></span>
                {% if pack.listed %}
                    <span data-bs-toggle="tooltip"
                          data-bs-title="This Content Pack is visible to all users"><i class="bi-eye"></i> Public</span>
                {% else %}
                    <span data-bs-toggle="tooltip"
                          data-bs-title="This Content Pack can only be accessed by users with the direct link"><i class="bi-eye-slash"></i> Unlisted</span>
                {% endif %}
            </div>
        </div>
        <!-- Pack info -->
        {% if pack.summary or pack.description %}
            <div class="vstack gap-1 col-md-9">
                {% if pack.summary %}<div class="mb-last-0">{{ pack.summary|safe_rich_text|safe }}</div>{% endif %}
                {% if pack.description %}
                    <div class="text-muted fs-7 mb-last-0">{{ pack.description|safe_rich_text|safe }}</div>
                {% endif %}
            </div>
        {% endif %}
        <!-- Content -->
        {% for section in content_sections %}
            <section>
                <div class="d-flex justify-content-between align-items-center mb-3 bg-body-secondary rounded px-2 py-1">
                    <h2 class="h5 mb-0">
                        {{ section.label }}
                        {% if section.count > 0 %}<span class="badge bg-primary">{{ section.count }}</span>{% endif %}
                    </h2>
                    {% if can_edit %}
                        <span class="d-flex gap-2 align-items-center">
                            {% if section.archived_count > 0 %}
                                <a href="{% url 'core:pack-archived-items' pack.id section.slug %}"
                                   class="link-secondary link-underline-opacity-25 link-underline-opacity-100-hover small">Archived ({{ section.archived_count }})</a>
                            {% endif %}
                            {% if section.can_add %}
                                <a href="{% url 'core:pack-add-item' pack.id section.slug %}"
                                   class="btn btn-primary btn-sm">
                                    <i class="bi-plus-lg"></i> Add
                                </a>
                            {% endif %}
                        </span>
                    {% endif %}
                </div>
                {% if section.slug == "weapon" %}
                    {% if section.items %}
                        <table class="table table-sm table-borderless mb-0 fs-7">
                            <thead class="table-group-divider">
                                <tr>
                                    <th scope="col"></th>
                                    <th class="text-center" scope="col">S</th>
                                    <th class="text-center" scope="col">L</th>
                                    <th class="text-center border-start" scope="col">S</th>
                                    <th class="text-center" scope="col">L</th>
                                    <th class="text-center border-start" scope="col">Str</th>
                                    <th class="text-center" scope="col">Ap</th>
                                    <th class="text-center" scope="col">D</th>
                                    <th class="text-center" scope="col">Am</th>
                                </tr>
                            </thead>
                            {% for entry in section.items %}
                                <tbody class="table-group-divider">
                                    {% include "core/pack/includes/weapon_profiles_display.html" with profiles=entry.profiles pack_item=entry.pack_item weapon=entry.content_object can_edit=can_edit %}
                                </tbody>
                            {% endfor %}
                        </table>
                    {% else %}
                        <p class="text-center text-secondary mb-0">No {{ section.label|lower }} in this Content Pack yet.</p>
                    {% endif %}
                {% elif section.items %}
                    <ul class="list-unstyled mb-0">
                        {% for entry in section.items %}
                            <li class="py-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>{{ entry.content_object }}</span>
                                    {% if can_edit %}
                                        <span class="d-flex gap-2">
                                            {% if section.can_add %}
                                                <a href="{% url 'core:pack-edit-item' pack.id entry.pack_item.id %}"
                                                   class="link-secondary link-underline-opacity-25 link-underline-opacity-100-hover small">Edit</a>
                                            {% endif %}
                                            <a href="{% url 'core:pack-delete-item' pack.id entry.pack_item.id %}"
                                               class="link-danger link-underline-opacity-25 link-underline-opacity-100-hover small">Archive</a>
                                        </span>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-center text-secondary mb-0">No {{ section.label|lower }} in this Content Pack yet.</p>
                {% endif %}
            </section>
        {% endfor %}
        <!-- Activity -->
        <section>
            <div class="d-flex justify-content-between align-items-center mb-3 bg-body-secondary rounded px-2 py-1">
                <h2 class="h5 mb-0">Activity</h2>
                {% if total_activity_count > 0 %}
                    <a href="{% url 'core:pack-activity' pack.id %}"
                       class="link-primary link-underline-opacity-25 link-underline-opacity-100-hover small">View all →</a>
                {% endif %}
            </div>
            {% if recent_activities %}
                <div class="list-group list-group-flush">
                    {% for activity in recent_activities %}
                        {% include "core/includes/pack_activity_item.html" with activity=activity %}
                    {% endfor %}
                </div>
                {% if total_activity_count > 5 %}
                    <a href="{% url 'core:pack-activity' pack.id %}"
                       class="small mt-2 d-inline-block">View all {{ total_activity_count }} activities →</a>
                {% endif %}
            {% else %}
                <p class="text-muted small mb-0">No activity yet.</p>
            {% endif %}
        </section>
    </div>
{% endblock content %}
